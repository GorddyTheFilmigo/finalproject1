<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Management Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f9;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    .header h1 {
      font-size: 32px;
      color: #1f2937;
    }
    .header p {
      font-size: 18px;
      color: #6b7280;
    }

    .section {
      margin-bottom: 50px;
    }
    .section h2 {
      font-size: 24px;
      color: #1f2937;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 10px;
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .card-body {
      padding: 20px;
    }
    .card-title {
      font-size: 18px;
      font-weight: bold;
    }
    .card-text {
      color: #6b7280;
    }

    .project-card {
      transition: transform 0.2s;
    }
    .project-card:hover {
      transform: translateY(-5px);
    }

    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
    }
    .status-active { background-color: #10b981; color: white; }
    .status-pending { background-color: #f59e0b; color: white; }
    .status-completed { background-color: #3b82f6; color: white; }
    .status-onhold { background-color: #ef4444; color: white; }

    .priority-high { color: #ef4444; }
    .priority-medium { color: #f59e0b; }
    .priority-low { color: #10b981; }

    .progress {
      height: 10px;
      margin-top: 10px;
    }

    .budget-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .budget-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .form-control, .form-select {
      border-radius: 8px;
    }

    .btn-primary {
      background-color: #3b82f6;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
    }

    .btn-success {
      background-color: #10b981;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
    }

    .btn-finance {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 8px;
      padding: 12px 30px;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .btn-finance:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    .table {
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
    }

    .modal-content {
      border-radius: 12px;
    }

    .timeline-item {
      border-left: 3px solid #3b82f6;
      padding-left: 20px;
      margin-bottom: 20px;
      position: relative;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -7px;
      top: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #3b82f6;
    }

    .team-member {
      display: inline-block;
      margin-right: 10px;
    }

    .avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background-color: #3b82f6;
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .badge-pending { background:#f59e0b;color:#fff;padding:4px 8px;border-radius:12px;font-size:11px; }
    .badge-approved { background:#10b981;color:#fff;padding:4px 8px;border-radius:12px;font-size:11px; }
  </style>
</head>
<body>

  <div class="header">
    <h1><i class="fas fa-project-diagram me-2"></i>Project Management Department</h1>
  </div>

  <!-- Budget Overview -->
  <div class="budget-summary">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h3><i class="fas fa-calculator me-2"></i> Total Budget Summary</h3>
        <div class="budget-item">
          <span>Total Allocated Budget:</span>
          <strong id="totalBudget">Ksh 0.00</strong>
        </div>
        <div class="budget-item">
          <span>Total Spent:</span>
          <strong id="totalSpent">Ksh 0.00</strong>
        </div>
        <div class="budget-item">
          <span>Remaining Budget:</span>
          <strong id="remainingBudget">Ksh 0.00</strong>
        </div>
      </div>
      <div class="col-md-4 text-end">
        <div id="financeStatus" class="mb-2"></div>
        <button class="btn btn-finance" id="sendFinanceBtn" onclick="sendToFinance()">
          <i class="fas fa-paper-plane me-2"></i> Send to Finance Department
        </button>
      </div>
    </div>
  </div>

  <!-- Project Statistics -->
  <div class="section">
    <h2><i class="fas fa-chart-pie me-2"></i> Project Statistics</h2>
    <div class="row">
      <div class="col-md-3 mb-3">
        <div class="card">
          <div class="card-body text-center">
            <i class="fas fa-tasks fa-3x text-primary mb-3"></i>
            <h3 id="totalProjects">0</h3>
            <p class="card-text">Total Projects</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card">
          <div class="card-body text-center">
            <i class="fas fa-spinner fa-3x text-warning mb-3"></i>
            <h3 id="activeProjects">0</h3>
            <p class="card-text">Active Projects</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card">
          <div class="card-body text-center">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h3 id="completedProjects">0</h3>
            <p class="card-text">Completed</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card">
          <div class="card-body text-center">
            <i class="fas fa-users fa-3x text-info mb-3"></i>
            <h3 id="totalTeamMembers">0</h3>
            <p class="card-text">Team Members</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Projects List -->
  <div class="section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2><i class="fas fa-folder-open me-2"></i> Projects</h2>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">
        <i class="fas fa-plus me-2"></i> Add New Project
      </button>
    </div>
    <div class="row" id="projectsList">
      <!-- Projects will be loaded here -->
    </div>
  </div>

  <!-- Tasks Section -->
  <div class="section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2><i class="fas fa-tasks me-2"></i> Tasks</h2>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
        <i class="fas fa-plus me-2"></i> Add New Task
      </button>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Task Name</th>
                <th>Project</th>
                <th>Assigned To</th>
                <th>Priority</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tasksList">
              <!-- Tasks will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Team Members -->
  <div class="section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2><i class="fas fa-users me-2"></i> Team Members</h2>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeamMemberModal">
        <i class="fas fa-user-plus me-2"></i> Add Team Member
      </button>
    </div>
    <div class="row" id="teamMembersList">
      <!-- Team members will be loaded here -->
    </div>
  </div>

  <!-- Timeline -->
  <div class="section">
    <h2><i class="fas fa-clock me-2"></i> Project Timeline</h2>
    <div class="card">
      <div class="card-body">
        <div id="timelineList">
          <!-- Timeline will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Add Project Modal -->
  <div class="modal fade" id="addProjectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addProjectForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Project Name</label>
                <input type="text" class="form-control" name="name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Client</label>
                <input type="text" class="form-control" name="client" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="3" required></textarea>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" name="startDate" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" name="endDate" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Budget (Ksh)</label>
                <input type="number" class="form-control" name="budget" step="0.01" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" name="status" required>
                  <option value="active">Active</option>
                  <option value="pending">Pending</option>
                  <option value="completed">Completed</option>
                  <option value="onhold">On Hold</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Priority</label>
                <select class="form-select" name="priority" required>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Project Manager</label>
              <input type="text" class="form-control" name="manager" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="addProject()">Add Project</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Update Modal (NEW) -->
  <div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Update Project Progress</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Coverage % (0-100)</label>
          <input type="number" id="progressInput" class="form-control" min="0" max="100" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="saveProgress()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addTaskForm">
            <div class="mb-3">
              <label class="form-label">Task Name</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Project</label>
              <select class="form-select" name="projectId" id="taskProjectSelect" required>
                <option value="">Select Project</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Assigned To</label>
              <input type="text" class="form-control" name="assignedTo" required>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Priority</label>
                <select class="form-select" name="priority" required>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-control" name="dueDate" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" name="status" required>
                <option value="pending">Pending</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="addTask()">Add Task</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Team Member Modal -->
  <div class="modal fade" id="addTeamMemberModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Team Member</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addTeamMemberForm">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="email" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Role</label>
              <input type="text" class="form-control" name="role" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Department</label>
              <select class="form-select" name="department" required>
                <option value="Development">Development</option>
                <option value="Design">Design</option>
                <option value="Marketing">Marketing</option>
                <option value="Sales">Sales</option>
                <option value="Management">Management</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" name="phone">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="addTeamMember()">Add Member</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Data storage using localStorage
    let projects = JSON.parse(localStorage.getItem('projects')) || [];
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    let teamMembers = JSON.parse(localStorage.getItem('teamMembers')) || [];
    let financeStatus = localStorage.getItem('financeStatus') || 'none'; // none | pending | approved

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadProjects();
      loadTasks();
      loadTeamMembers();
      updateStatistics();
      updateBudgetSummary();
      loadTimeline();
      populateProjectSelect();
      updateFinanceBadge();
    });

    function saveToLocalStorage() {
      localStorage.setItem('projects', JSON.stringify(projects));
      localStorage.setItem('tasks', JSON.stringify(tasks));
      localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
      localStorage.setItem('financeStatus', financeStatus);
    }

    function loadProjects() {
      const projectsList = document.getElementById('projectsList');
      projectsList.innerHTML = '';

      projects.forEach(project => {
        const statusClass = `status-${project.status}`;
        const priorityClass = `priority-${project.priority}`;
        
        projectsList.innerHTML += `
          <div class="col-md-4 mb-3">
            <div class="card project-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="card-title">${project.name}</h5>
                  <span class="status-badge ${statusClass}">${project.status.toUpperCase()}</span>
                </div>
                <p class="card-text"><i class="fas fa-user me-2"></i>${project.client}</p>
                <p class="card-text"><small class="text-muted">${project.description}</small></p>
                <div class="mb-2">
                  <small class="text-muted">Priority:</small>
                  <i class="fas fa-flag ${priorityClass} ms-2"></i>
                  <span class="${priorityClass}">${project.priority.toUpperCase()}</span>
                </div>
                <div class="mb-2">
                  <small class="text-muted">Manager: ${project.manager}</small>
                </div>
                <div class="mb-2">
                  <small class="text-muted">Budget: Ksh ${project.budget.toLocaleString()} | Spent: Ksh ${(project.spent || 0).toLocaleString()}</small>
                </div>
                <div class="mb-2">
                  <small class="text-muted">Progress: ${project.progress || 0}%</small>
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: ${project.progress || 0}%"></div>
                  </div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                  <small class="text-muted">${project.startDate} to ${project.endDate}</small>
                  <div>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="viewProject('${project.id}')">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="openProgressModal('${project.id}')">
                      <i class="fas fa-edit"></i> Update Progress
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      });
    }

    // Progress Modal Logic
    let currentProgressId = null;
    function openProgressModal(id) {
      currentProgressId = id;
      const project = projects.find(p => p.id === id);
      document.getElementById('progressInput').value = project.progress || 0;
      new bootstrap.Modal(document.getElementById('progressModal')).show();
    }

    function saveProgress() {
      const value = parseInt(document.getElementById('progressInput').value);
      if (isNaN(value) || value < 0 || value > 100) {
        alert('Please enter a valid percentage (0-100).');
        return;
      }
      const idx = projects.findIndex(p => p.id === currentProgressId);
      if (idx !== -1) {
        projects[idx].progress = value;
        saveToLocalStorage();
        loadProjects();
        updateBudgetSummary();
        bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
      }
    }

    function loadTasks() {
      const tasksList = document.getElementById('tasksList');
      tasksList.innerHTML = '';

      tasks.forEach(task => {
        const priorityClass = `priority-${task.priority}`;
        tasksList.innerHTML += `
          <tr>
            <td>${task.name}</td>
            <td>${task.project}</td>
            <td>${task.assignedTo}</td>
            <td><i class="fas fa-flag ${priorityClass}"></i> ${task.priority.toUpperCase()}</td>
            <td>${task.dueDate}</td>
            <td><span class="badge bg-info">${task.status}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editTask('${task.id}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteTask('${task.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
    }

    function loadTeamMembers() {
      const teamMembersList = document.getElementById('teamMembersList');
      teamMembersList.innerHTML = '';

      teamMembers.forEach(member => {
        const initials = member.name.split(' ').map(n => n[0]).join('');
        teamMembersList.innerHTML += `
          <div class="col-md-4 mb-3">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <div class="avatar me-3">${initials}</div>
                  <div>
                    <h6 class="mb-0">${member.name}</h6>
                    <small class="text-muted">${member.role}</small>
                  </div>
                </div>
                <p class="mb-1"><i class="fas fa-envelope me-2"></i>${member.email}</p>
                <p class="mb-1"><i class="fas fa-building me-2"></i>${member.department}</p>
                <p class="mb-0"><i class="fas fa-phone me-2"></i>${member.phone || 'N/A'}</p>
              </div>
            </div>
          </div>
        `;
      });
    }

    function updateStatistics() {
      document.getElementById('totalProjects').textContent = projects.length;
      document.getElementById('activeProjects').textContent = projects.filter(p => p.status === 'active').length;
      document.getElementById('completedProjects').textContent = projects.filter(p => p.status === 'completed').length;
      document.getElementById('totalTeamMembers').textContent = teamMembers.length;
    }

    function updateBudgetSummary() {
      const totalBudget = projects.reduce((sum, p) => sum + p.budget, 0);
      const totalSpent = projects.reduce((sum, p) => sum + (p.spent || 0), 0);
      const remaining = totalBudget - totalSpent;

      document.getElementById('totalBudget').textContent = `Ksh ${totalBudget.toLocaleString()}`;
      document.getElementById('totalSpent').textContent = `Ksh ${totalSpent.toLocaleString()}`;
      document.getElementById('remainingBudget').textContent = `Ksh ${remaining.toLocaleString()}`;
    }

    function updateFinanceBadge() {
      const el = document.getElementById('financeStatus');
      if (financeStatus === 'pending') {
        el.innerHTML = '<span class="badge-pending">Pending Finance Approval</span>';
      } else if (financeStatus === 'approved') {
        el.innerHTML = '<span class="badge-approved">Approved by Finance</span>';
      } else {
        el.innerHTML = '';
      }
    }

    function loadTimeline() {
      const timelineList = document.getElementById('timelineList');
      timelineList.innerHTML = '';

      const events = [
        ...projects.map(p => ({
          date: p.startDate,
          title: `Project Started: ${p.name}`,
          description: `${p.client} - Budget: Ksh ${p.budget.toLocaleString()}`
        })),
        ...tasks.filter(t => t.status === 'completed').map(t => ({
          date: t.dueDate,
          title: `Task Completed: ${t.name}`,
          description: `Project: ${t.project} - ${t.assignedTo}`
        }))
      ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

      events.forEach(event => {
        timelineList.innerHTML += `
          <div class="timeline-item">
            <small class="text-muted">${event.date}</small>
            <h6>${event.title}</h6>
            <p class="text-muted mb-0">${event.description}</p>
          </div>
        `;
      });
    }

    function populateProjectSelect() {
      const select = document.getElementById('taskProjectSelect');
      select.innerHTML = '<option value="">Select Project</option>';
      projects.forEach(project => {
        select.innerHTML += `<option value="${project.id}">${project.name}</option>`;
      });
    }

    function addProject() {
      const form = document.getElementById('addProjectForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const formData = new FormData(form);
      
      const newProject = {
        id: Date.now().toString(),
        name: formData.get('name'),
        client: formData.get('client'),
        description: formData.get('description'),
        startDate: formData.get('startDate'),
        endDate: formData.get('endDate'),
        budget: parseFloat(formData.get('budget')),
        spent: 0,
        status: formData.get('status'),
        priority: formData.get('priority'),
        manager: formData.get('manager'),
        progress: 0,
        department: 'Project Management'
      };

      projects.push(newProject);
      saveToLocalStorage();
      loadProjects();
      updateStatistics();
      updateBudgetSummary();
      loadTimeline();
      populateProjectSelect();
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addProjectModal'));
      modal.hide();
      form.reset();
      
      alert('Project added successfully!');
    }

    function addTask() {
      const form = document.getElementById('addTaskForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const formData = new FormData(form);
      
      const projectId = formData.get('projectId');
      const project = projects.find(p => p.id === projectId);
      
      const newTask = {
        id: Date.now().toString(),
        name: formData.get('name'),
        projectId: projectId,
        project: project ? project.name : '',
        description: formData.get('description'),
        assignedTo: formData.get('assignedTo'),
        priority: formData.get('priority'),
        dueDate: formData.get('dueDate'),
        status: formData.get('status')
      };

      tasks.push(newTask);
      saveToLocalStorage();
      loadTasks();
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
      modal.hide();
      form.reset();
      
      alert('Task added successfully!');
    }

    function addTeamMember() {
      const form = document.getElementById('addTeamMemberForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const formData = new FormData(form);
      
      const newMember = {
        id: Date.now().toString(),
        name: formData.get('name'),
        email: formData.get('email'),
        role: formData.get('role'),
        department: formData.get('department'),
        phone: formData.get('phone')
      };

      teamMembers.push(newMember);
      saveToLocalStorage();
      loadTeamMembers();
      updateStatistics();
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addTeamMemberModal'));
      modal.hide();
      form.reset();
      
      alert('Team member added successfully!');
    }

    function viewProject(id) {
      const project = projects.find(p => p.id === id);
      if (project) {
        alert(`Project Details:\n\nName: ${project.name}\nClient: ${project.client}\nStatus: ${project.status}\nBudget: Ksh ${project.budget.toLocaleString()}\nSpent: Ksh ${(project.spent || 0).toLocaleString()}\nProgress: ${project.progress || 0}%`);
      }
    }

    function editTask(id) {
      const task = tasks.find(t => t.id === id);
      if (task) {
        const modal = new bootstrap.Modal(document.getElementById('addTaskModal'));
        modal.show();

        const form = document.getElementById('addTaskForm');
        form.name.value = task.name;
        form.projectId.value = task.projectId;
        form.description.value = task.description;
        form.assignedTo.value = task.assignedTo;
        form.priority.value = task.priority;
        form.dueDate.value = task.dueDate;
        form.status.value = task.status;

        const addButton = document.querySelector('#addTaskModal .btn-primary');
        addButton.textContent = 'Update Task';
        addButton.onclick = () => updateTask(id);
      }
    }

    function updateTask(id) {
      const form = document.getElementById('addTaskForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const formData = new FormData(form);
      
      const taskIndex = tasks.findIndex(t => t.id === id);
      if (taskIndex !== -1) {
        const projectId = formData.get('projectId');
        const project = projects.find(p => p.id === projectId);
        
        tasks[taskIndex] = {
          ...tasks[taskIndex],
          name: formData.get('name'),
          projectId: projectId,
          project: project ? project.name : '',
          description: formData.get('description'),
          assignedTo: formData.get('assignedTo'),
          priority: formData.get('priority'),
          dueDate: formData.get('dueDate'),
          status: formData.get('status')
        };

        saveToLocalStorage();
        loadTasks();
        loadTimeline();

        const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
        modal.hide();
        form.reset();

        const addButton = document.querySelector('#addTaskModal .btn-primary');
        addButton.textContent = 'Add Task';
        addButton.onclick = addTask;

        alert('Task updated successfully!');
      }
    }

    function deleteTask(id) {
      if (confirm('Are you sure you want to delete this task?')) {
        tasks = tasks.filter(t => t.id !== id);
        saveToLocalStorage();
        loadTasks();
        loadTimeline();
        alert('Task deleted successfully!');
      }
    }

    function sendToFinance() {
      if (financeStatus === 'pending') {
        alert('Budget request already sent. Awaiting Finance approval.');
        return;
      }
      if (financeStatus === 'approved') {
        alert('Budget already approved by Finance.');
        return;
      }

      const totalBudget = projects.reduce((sum, p) => sum + p.budget, 0);
      const totalSpent = projects.reduce((sum, p) => sum + (p.spent || 0), 0);
      const remaining = totalBudget - totalSpent;

      const financeData = {
        source: 'Project Management',
        timestamp: new Date().toISOString(),
        summary: {
          total_budget: totalBudget,
          total_spent: totalSpent,
          remaining_budget: remaining,
          total_projects: projects.length,
          active_projects: projects.filter(p => p.status === 'active').length
        },
        projects: projects.map(p => ({
          id: p.id,
          name: p.name,
          client: p.client,
          department: p.department || 'Project Management',
          budget: p.budget,
          spent: p.spent || 0,
          remaining: p.budget - (p.spent || 0),
          status: p.status,
          priority: p.priority,
          manager: p.manager,
          start_date: p.startDate,
          end_date: p.endDate,
          progress: p.progress || 0
        })),
        team_summary: {
          total_members: teamMembers.length,
          by_department: teamMembers.reduce((acc, member) => {
            acc[member.department] = (acc[member.department] || 0) + 1;
            return acc;
          }, {})
        }
      };

      console.log('Finance Data Submitted:', financeData);
      financeStatus = 'pending';
      saveToLocalStorage();
      updateFinanceBadge();

      setTimeout(() => {
        if (confirm('Finance Department: Approve the budget request?')) {
          financeStatus = 'approved';
          saveToLocalStorage();
          updateFinanceBadge();
          alert('Budget approved by Finance Department!');
        } else {
          financeStatus = 'none';
          saveToLocalStorage();
          updateFinanceBadge();
          alert('Finance rejected the request.');
        }
      }, 2000);
    }
  </script>
</body>
</html>